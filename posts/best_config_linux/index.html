<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>最佳实践-Linux环境配置 | DataLearning</title>
<meta name=keywords content="配置,linux,软件">
<meta name=description content="最佳实践：linux下面电脑软件的搭配情况，确保高效、安全">
<meta name=author content="Suai">
<link rel=canonical href=https://suai.tk/posts/best_config_linux/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://suai.tk/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://suai.tk/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://suai.tk/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://suai.tk/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://suai.tk/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="最佳实践-Linux环境配置">
<meta property="og:description" content="最佳实践：linux下面电脑软件的搭配情况，确保高效、安全">
<meta property="og:type" content="article">
<meta property="og:url" content="https://suai.tk/posts/best_config_linux/"><meta property="og:image" content="https://suai.tk/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-02-26T18:21:44+08:00">
<meta property="article:modified_time" content="2022-02-26T18:21:44+08:00"><meta property="og:site_name" content="DataLearning">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://suai.tk/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="最佳实践-Linux环境配置">
<meta name=twitter:description content="最佳实践：linux下面电脑软件的搭配情况，确保高效、安全">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://suai.tk/posts/"},{"@type":"ListItem","position":2,"name":"最佳实践-Linux环境配置","item":"https://suai.tk/posts/best_config_linux/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"最佳实践-Linux环境配置","name":"最佳实践-Linux环境配置","description":"最佳实践：linux下面电脑软件的搭配情况，确保高效、安全","keywords":["配置","linux","软件"],"articleBody":"虚拟机集群 常规配置 换源 vps 可不用换源\n# 更换源 cp -a /etc/apt/sources.list /etc/apt/sources.list.bak ## 如果失效，则使用下方的 sed -i \"s@http://ftp.debian.org@https://mirrors.tuna.tsinghua.edu.cn@g\" /etc/apt/sources.list sed -i \"s@http://security.debian.org@https://mirrors.tuna.tsinghua.edu.cn@g\" /etc/apt/sources.list # 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释 deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free apt install apt-transport-https ca-certificates apt update 加速  github仓库Chikage0o0/Linux-NetSpeed: 将Linux现常用的网络加速集成在一起  开启ssh  service ssh status, 通过配置 hosts.allow 和 hosts.deny 文件允许或禁止 ssh 或 telnet 操作 - 诸子流 - 博客园  sudo vim /etc/ssh/sshd_config Port xxxx PermitRootLogin yes PubkeyAuthentication yes AuthorizedKeysFile .ssh/authorized_keys # 不要关闭连接, 在新连接中执行以下语句 systemctl restart sshd.service ## 一键替换 sed -i \"s/#Port 22/Port 6868/\" /etc/ssh/sshd_config # sed -i \"s/ListenStream=22/ListenStream=6868/\" /etc/systemd/system/sockets.target.wants/ssh.socket # 传送好密钥，并确保可登录后，再禁用掉密码登录 PasswordAuthentication no 配置密钥  清除过旧数据, ssh-keygen -R [172.20.16.163]:xxx 添加ssh登录密钥  # C:/Users/username/.ssh/config # ~/.ssh/config Host lxc_centos HostName 192.168.31.xxx User root Port xxx IdentityFile \"~/.ssh/lxc_rsa\" 通用配置方式  NAME_IDRSA=\"xxx@xxx.nas\" FILE_IDRSA=\"C:/Users/username/.ssh/pve/xxx_rsa\" PORT=xxx IP_ADDR=\"root@192.168.31.xxx\" ssh-keygen -t rsa -C ${NAME_IDRSA} -f ${FILE_IDRSA} ssh-copy-id -i ${FILE_IDRSA} -p ${PORT} ${IP_ADDR} 问题解决  #sign_and_send_pubkey: signing failed: agent refused operation ssh-add cc8 deepin centos ssh-add -l # WARNING: UNPROTECTED PRIVATE KEY FILE!, too open sudo chmod 700 '.ssh/*id_rsa'   静态 ip cp /etc/network/interfaces /etc/network/interfaces.bkp vim /etc/network/interfaces auto ensXX iface ensXX inet static address 192.168.31.xxx netmask 255.255.255.0 # 设置网关 # gateway 192.168.31.2 gateway 192.168.31.1 dns-nameservers 192.168.31.x 192.168.31.1 apt install resolvconf cp -p /etc/resolvconf/resolv.conf.d/head /etc/resolvconf/resolv.conf.d/head.orig vim /etc/resolvconf/resolv.conf.d/head nameserver 192.168.31.2 nameserver 192.168.31.1 # nameserver 8.8.8.8 # nameserver 114.114.114.114 systemctl restart networking.service reboot # init 6 基础软件配置  安装基本软件  # 更新 apt update -y \u0026\u0026 apt install sudo -y apt upgrade -y sudo apt install -y git vim wget screen curl dnsutils # sudo vim /etc/vim/vimrc tee -a /etc/vim/vimrcsyntax on set smartcase set number set shiftwidth=4 set tabstop=4 set expandtab EOF # vim paste 格式错乱 1. 先设定, `set paste` 2. 插入模式，粘贴 禁用启动项  systemd-analyze blame systemctl disable pve-daily-update.service systemctl disable apt-daily.service systemctl disable apt-daily-upgrade.service 配置 swap  sudo swapon --show sudo fallocate -l 1G /swapfile sudo chmod 600 /swapfile sudo mkswap /swapfile sudo swapon /swapfile sudo vi /etc/fstab /swapfile swap swap defaults 0 0 sudo swapon --show # 关闭swap sudo swapoff -a vim /etc/fstab, 注释掉swap 设置时间、时区、本地化  sudo apt install ntpdate locales -y sudo ntpdate time.windows.com sudo dpkg-reconfigure tzdata sudo dpkg-reconfigure locales # 或者编辑文件 sudo vim /etc/locale.gen #zh_CN.UTF-8 sudo locale-gen localectl set-locale LANG=zh_CN.UTF-8 使用zsh\u0026zinit, 见最佳实践-ZSH  穿透及网络安全   zerotier, 局域网内不需要每个都安装, openwrt可开启nat\n 常规安装  ## 安装 curl -s https://install.zerotier.com | sudo bash # 如果没有任何反应，可能是因为代理的原因 # 关闭代理，然后source ~/.zshrc sudo zerotier-cli join 6**** sudo systemctl enable zerotier-one https://my.zerotier.com/network/6*** # 如果无法使用systemctl,则添加重启脚本如下 sudo vim /etc/rc.local zerotier-one -d lxc中无法直接是用zerotier。lxc zerotier-one[127]: ERROR: unable to configure virtual network port: could not open TUN/TAP device: No such file or directory  vim /etc/pve/lxc/105.conf lxc.cgroup.devices.allow = c 10:200 rwm lxc.hook.autodev = sh -c \"modprobe tun; cd ${LXC_ROOTFS_MOUNT}/dev; mkdir net; mknod net/tun c 10 200; chmod 0666 net/tun\" zerotier安装在旁路由, 参照里面设置：LEDE旁路由中安装zerotier，内网穿透，访问局域网，极简教程 - LEDE/OpenWRT - KoolShare - 源于玩家 服务玩家  ztklhszno7 iptables -I FORWARD -i ztklhszno7 -j ACCEPT iptables -I FORWARD -o ztklhszno7 -j ACCEPT iptables -t nat -I POSTROUTING -o ztklhszno7 -j MASQUERADE 修改工作机的dns为旁路由，即可使用旁路由的局域网域名 卸载  # 通过dpkg删除zerotier-one服务 dpkg -P zerotier-one # 删除zerotier-one文件夹，该文件夹存储了address地址，删除后再次安装会获得新的address地址 rm -rf /var/lib/zerotier-one/ ZEROTIER使用指引  https://XX.xxx.top/login?redirect=%2Ffiles%2F 1. 安装zerotier软件 2. 加入 6*** 3. 在任务栏的搜索框中，键入“远程桌面连接”，然后选择“远程桌面连接”。 4. 计算机：192.168.31.XXX:3389, 连接 5. 用户名：username，密码：password   ufw\n  apt install ufw -y ufw status|enable|disable|reset # 开放端口 # 允许端口22[80|443]上的所有链接 ufw allow ssh[http|https] # 非正常端口 ufw allow 6868 ufw allow 80/tcp ufw allow 21/udp ufw allow 9000:9010/tcp ufw allow[deny] from 192.168.31.182[0/24] ufw allow from 192.168.31.182 to any port 80 [protol tcp/udp] ufw status verbose ufw deny 80 ufw delete allow http ufw delete deny 22 fail2ban  apt install fail2ban -y cp /etc/fail2ban/fail2ban.conf /etc/fail2ban/fail2ban.local ignoreip = 127.0.0.1/8 ::1 192.168.31.0/24 # /etc/fail2ban # fail2ban.conf ：配置文件里面定义了fail2ban记录的日志等级、日志文件的位置以及socket。 # jail.conf 里面定义了对那些服务进行监控，以及使用的一些策略。 apt-get install fail2ban #启动\u0026开机自启 systemctl start fail2ban.service systemctl enable fail2ban.service clamav, 参考ClamAV - Ubuntu中文  可选安装-字体、温度监控等 sudo apt install psensor apt install fonts-firacode fonts-wqy-zenhei -y fc-list | awk '{$1=\"\"}1' | cut -d: -f1 | sort| uniq Fira Code Retina PROXMOX 硬盘配置  Proxmox VE（PVE）添加硬盘 - 星哥的博客  工具及网络  pvetools工具，ivanhao/pvetools 为pve增加ipv6，增加 ipve6 ## 开启IPV6 vim /etc/hosts -- 10.0.0.100 pvehost.some.domain pvehost pvelocalhost ++ ::ffff:10.0.0.100 pvehost.some.domain pvehost pvelocalhost systemctl restart pveproxy.service # tcp6 0 0 :::8006 :::* LISTEN -  Promox VE(PVE)安装虚拟黑群晖实现硬盘休眠避坑指南 - 十佳测评 ata-ST3000DM008_Z294S0UH - ../../sdb qm set 100 --sata0 /dev/disk/by-id/ata-ST3000DM008_Z294S0UH   lxc虚拟机配置  安装lxc相关  配置 lxc 源, 或者访问系统, 其它软件  grep -rn \"download.proxmox.com\" /usr/share/perl5/PVE/* #查找设定下载源的文件 sed -i.bak \"s#http://download.proxmox.com/images#https://mirrors.ustc.edu.cn/proxmox/images#g\" /usr/share/perl5/PVE/APLInfo.pm wget -O /var/lib/pve-manager/apl-info/mirrors.ustc.edu.cn https://mirrors.ustc.edu.cn/proxmox/images/aplinfo-pve-6.dat 使用第三方的lxc镜像。【系统镜像】Debian 10 LXC/OVZ 最新模板 v1.3（开启 SSH、时区、优化） - CXT - Enjoy Life | 生活、技术、交友、分享 安装完成后，配置好linux环境，备份成lxc模板  # 包含了配置好的源、docker、本地化、ssh、字体等等，zsh, ufw /mnt/pve/Media/dump/vzdump-lxc-initial-debian-20210702.tar.gz 安装 lxc, 参考 gienginali - 複製 LXC 虛擬機  cd /mnt/sdb/images cp -r 200 210 cd 210 \u0026\u0026 mv vm-200-disk-0.raw vm-210-disk-0.raw cd /etc/pve/nodes/pve/lxc cp 200.conf 210.conf # restore 到113, 无特权的√取消 vim 210.conf # 进行网段扫描，去掉被占用的ip apt install nmap nmap -sP 192.168.31.0/24 cat /proc/net/arp # [在线MAC地址生成器-在线工具](http://www.metools.info/other/o66.html) # 进行ip、mac、硬盘等修改 rootfs: sdb:210/vm-210-disk-0.raw,size=16G mp0: /mnt/pve/Media/share,mp=/home/share # 打开选项-功能-嵌套、NFS、smb/cifs 挂载 pve 目录，强制关闭虚拟机  #pct set 104 -mp0 /mnt/pve/Media/share,mp=/home/share qm stop 101; sleep 3; qm start 101 修改motd、hostname、ssh端口  vim /etc/motd vim /etc/hostname # 修改ssh端口后，ssh开机不自动启动 sed -i \"s/#Port 22/Port 12345/\" /etc/ssh/sshd_config sed -i \"s/ListenStream=22/ListenStream=12345/\" /etc/systemd/system/sockets.target.wants/ssh.socket 无法使用docker，operation cps。参考Running Docker on Proxmox - Dan [the] Salmon  # In Proxmox, edit the /etc/pve/lxc/.conf file where  is the ID given to your container: lxc.apparmor.profile: unconfined lxc.cgroup.devices.allow: a lxc.cap.drop:   win10  安装虚拟机  mstsc qm importdisk 101 /var/lib/vz/images/win10.qcow2 Media # virio block 直通 usb  dmesg | grep 'usb' # 记下要直通的usb序号, 编辑虚拟机conf文件 echo \"usb0: host=2-1.4\"  /etc/pve/qemu-server/101.conf qm stop 101;sleep 3; qm start 101 spice 配置 参考：proxmox VE 安装 Windows 虚拟机（包括 virtIO 驱动）及 SPICE 远程桌面配置_墨问西东的博客-CSDN 博客 spice://192.168.31.184:60002,password #远程界面选择服务器节点pve1，选择shell，cd到/etc/pve/qemu-server目录下，服务器上安装的虚拟机配置文件均在此目录下。在虚拟机配置文件中添加一下内容（如100.conf）： z qemu(cd /etc/pve/nodes/pve/qemu-server) args: -spice port=61003,addr=0.0.0.0,password=password,seamless-migration=on #其中，-spice即为配置SPICE； #port为监听端口，一般应大于61001； #addr为容许网络，设置为0.0.0.0为允许任何网络连接； #disable-ticketing为去掉密码验证，如需加密码验证，将此参数改为password=xxxx； #seamless-migration=on为QMP支持。 #设置完毕后在SPICE client端输入spice://ip:61002就可以正常远程连接了。   安装堡垒机(暂定) 安装数据库  只允许本地局域网连接,  ufw allow from 192.168.31.0/24 to any port 6868,3306,6379 proto tcp ufw allow from 192.168.31.0/24 to any port 6380,6381 proto tcp  ❯ netstat -tnl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State tcp 0 0 0.0.0.0:6868 0.0.0.0:* LISTEN tcp 0 0 172.17.0.1:24731 0.0.0.0:* LISTEN  mysql官网，MySQL :: Begin Your Download 安装 mysql # 检测是否安装过mysql dpkg -l | grep mysql # 下载mysql配置源 wget -c https://dev.mysql.com/get/mysql-apt-config_0.8.16-1_all.deb # 检测md5 sudo md5sum mysql-apt-config_0.8.16-1_all.deb dpkg -i mysql-apt-config_0.8.16-1_all.deb # 选择8.0及相关tools # 低配置情况下，选择5.7 apt update apt install mysql-server -y  创建数据库、授权 mysql -uroot -p -e \"show databases;\" # wzd2GEAKQAJBr7cHsVJoaiu6 DB_PASSWORD=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 24` echo -e \"\\033[31m 你的数据库密码是 $DB_PASSWORD\\033[0m\" mysql -uroot -p -e \"create database if not exists chevereto default charset 'utf8'; create user 'chv_lxc'@'192.168.31.175' identified with mysql_native_password by '$DB_PASSWORD'; grant all privileges on chevereto.* to 'chv_lxc'@'192.168.31.175' with grant option; flush privileges;\" # mysql -uroot -p -e \"alter user 'chv_lxc'@'192.168.31.175' identified with mysql_native_password by '$DB_PASSWORD';\" mysql -uroot -p -e \"rename user 'jmp_lxc'@'192.168.31.176' to 'jmp_lxc'@'192.168.31.100';grant all privileges on jumpserver.* to 'jmp_lxc'@'192.168.31.100' with grant option; flush privileges;\" mysql -uroot -p -e \"alter user 'jmp_lxc'@'192.168.31.176' identified with mysql_native_password by '$DB_PASSWORD';\" mysql -uroot -p -e \"alter database jumpserver character set 'utf8';\"  数据迁移, MySQL 修改默认存储路径 — 小明也来过的个人博客 systemctl stop mysql.service # 进行备份 cp -a -R /var/lib/mysql /home/share/bkp # 修改配置文件 vim /etc/mysql/mysql.conf.d/mysqld.cnf datadir = /home/share/bkp/mysql mysql -uroot -p -e \"show global variables like '%datadir%';\" mysqldump -h 10.1.2.24 -P 3306 -u esm-tmp -p -d mocha  dump.txt /usr/local/mysql/bin/mysqldump -uroot -p -d abc  abc.sql  彻底删除 # 彻底删除mysql dpkg --get-selections | grep mysql apt autoremove mysql-community-server mysql-community-client mysql-common mysql-client mysql-server --purge rm /etc/mysql/ -R \u0026\u0026 rm /var/lib/mysql/ -R #apt autoremove apparmor -y apt autoremove \u0026\u0026 apt autoclean  连接wsl的mysql sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf # bind-addr 注释掉 sudo service mysql start # 增加开机启动 vim /etc/init.wsl #! /bin/sh /etc/init.d/ssh $1 /etc/init.d/mysql $1  mysql问题解决  如果出现了错误：ERROR 2002 (HY000): Can’t connect to local MySQL server through socket ‘/var/run/mysqld/mysqld.sock’ (2)  vim /etc/mysql/my.conf [mysqld] skip-grant-tables systemctl restart mysql mysql -uroot -p flush privileges; set password for 'root'@'localhost'=password('****'); GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '****' WITH GRANT OPTION; CREATE USER 'root'@'%' IDENTIFIED BY 'PASSWORD'; GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;   安装redis   安装 redis, 打开选项-功能-嵌套、NFS、smb/cifs\napt install redis-server -y redis-cli ### 2021年12月28日 星期二 redis启动失败，后面无法继续 CONFIG get requirepass CONFIG set requirepass \"passwd\" auth \"passwd\" vim /etc/redis/redis.conf bind 127.0.0.1 192.168.31.126 192.168.31.200 192.168.31.201 192.168.31.202 192.168.31.210 192.168.31.211 requirepass passwd systemctl restart redis-server.service   问题解决\n echo never  593:M 02 Jul 2021 22:58:31.054 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect. 593:M 02 Jul 2021 22:58:31.054 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never  /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled. never echo never  /sys/kernel/mm/transparent_hugepage/enabled always [madvise] never pid文件  # redis, status, 提示没有pid文件 vim /etc/systemd/system/redis.service [Service] Type=forking ExecStart=/usr/bin/redis-server /etc/redis/redis.conf ExecStop=/bin/kill -s TERM $MAINPID ## 增加下面一行 ExecStartPost=/bin/sh -c \"echo $MAINPID /var/run/redis/redis.pid\" PIDFile=/run/redis/redis-server.pid Jumpyserver jumpserver logs 一直在wait redis  ## 升级redis到最新版本, lxc_debian,测试失败 # redis-server --version # apt update -y \u0026\u0026 apt upgrade -y # cp /etc/redis/redis.conf ~/redis.conf.bkp # export ALL_PROXY=socks5://192.168.31.2:10068 # unset ALL_PROXY # wget -N https://raw.githubusercontent.com/Websoft9/ansible-linux/main/scripts/install.sh; bash install.sh -r redis   配置哨兵模式, 配置并启动主从\ncp /etc/redis/redis.conf /etc/redis/redis-6380.conf cp /etc/redis/redis.conf /etc/redis/redis-6381.conf vim /etc/redis/redis-638*.conf port 638* pidfile /var/run/redis/redis-638*.pid logfile /var/log/redis/redis-638*.log replicaof 127.0.0.1 6379 masterauth nhsVU9z6T\u0026YHH\u0026 redis-server /etc/redis/redis-638*.conf ## 查看是否配置成功 redis-cli  auth nhsVU9z6T\u0026YHH\u0026  info Replication # 配置并启动哨兵 vim /etc/redis/sentinel-16379.conf port 16379 daemonize yes dir /var/run/redis/sentinel pidfile /var/run/redis/sentinel/redis-sentinel-16379.pid sentinel monitor mymaster 127.0.0.1 6379 2 sentinel auth-pass mymaster nhsVU9z6T\u0026YHH\u0026 sentinel down-after-milliseconds mymaster 5000 sentinel parallel-syncs mymaster 1 sentinel failover-timeout mymaster 15000 cp /etc/redis/sentinel-16379.conf /etc/redis/sentinel-16380.conf cp /etc/redis/sentinel-16379.conf /etc/redis/sentinel-16381.conf redis-server /etc/redis/redis-6380.conf \u0026\u0026 redis-server /etc/redis/redis-6381.conf redis-server /etc/redis/sentinel-16379.conf --sentinel \u0026\u0026 redis-server /etc/redis/sentinel-16380.conf --sentinel \u0026\u0026 redis-server /etc/redis/sentinel-16381.conf --sentinel ## 以下未试验成功 echo “/opt/redis/src/redis-sentinel /main/redis/sentinel.conf”  /etc/rc.local /usr/bin/redis-server /etc/redis/redis-6379.conf /usr/bin/redis-server /etc/redis/redis-6380.conf /usr/bin/redis-server /etc/redis/redis-6381.conf /usr/bin/redis-server /etc/redis/sentinel-16379.conf --sentinel /usr/bin/redis-server /etc/redis/sentinel-16380.conf --sentinel /usr/bin/redis-server /etc/redis/sentinel-16381.conf --sentinel   keepalived, 未成功\napt install keepalived vim /etc/keepalived/check_redis.sh #!/bin/bash if [ $? -eq 0 ]; then REDIS_PASSWD='nhsVU9z6T\u0026YHH\u0026' ROLE=`redis-cli -a ${REDIS_PASSWD} info replication | grep role` MASTER=`echo -e \"role:master\\r\\n\"` if [ \"$ROLE\" == \"$MASTER\" ]; then exit 0 fi # MASTERIP=`ip add | grep 192.168.31.20 | wc -l` # if [ $MASTERIP -eq 0 ]; then # exit 0 # fi fi exit 1 # 编写 Redis 集群切换邮件通知脚本，修改通知标题及正文内容 cp /etc/keepalived/email_tengine.sh /etc/keepalived/email_redis.sh vi /etc/keepalived/email_redis.sh #!/bin/bash contact='redis@xxx.top' notify() { mailsubject=\"[Devops Redis VIP 切换] $(hostname)- $1\" mailbody=\"[$(date +'%F %T')]: Devops Redis VIP 切换, $(hostname)切换为 $1！\" echo \"$mailbody\" | mail -s \"$mailsubject\" $contact } case $1 in master) notify master ;; backup) notify backup ;; fault) notify fault ;; *) echo \"Usage: $(basename $0){master|backup|fault}\" exit 1 ;; esac # 修改keepalived配置，添加一个新的VRRP实例，并添加相关的状态检查脚本 # 注意 keepalived 3个节点须工作在非抢占模式下，角色均设置为BACKUP，优先级相同。 vi /etc/keepalived/keepalived.conf vrrp_script chk_redis { script \"/etc/keepalived/check_redis.sh\" interval 1 } vrrp_instance VI_REDIS { state BACKUP nopreempt interface bond-app virtual_router_id 52 priority 100 advert_int 1 authentication { auth_type PASS auth_pass xxxxxxxx } virtual_ipaddress { 10.255.200.4/24 } track_script { chk_redis } notify_master \"/etc/keepalived/email_redis.sh master\" notify_backup \"/etc/keepalived/email_redis.sh backup\" notify_fault \"/etc/keepalived/email_redis.sh fault\" }   单机 deepin  安装系统盘，数据盘不要安装，后续再进行分区，然后挂载  git config --global user.name \"username\" git config --global user.email \"username@deepin\" 优化启动  systemd-analyze blame systemctl disable[mask] systemctl disable apt-daily.service # NetworkManager-wait-online.service 全盘备份, 定时备份（timemachie) 系统优化  # 进行挂载重命名 sudo e2label /dev/sdb1 \"Backup\" sudo e2label /dev/sdb2 \"Bigdata\" # /dev/sdb1 UUID=f20f1458-cd6e-4e5b-be8c-a871045fc7b8 /media/usernaem/backup ext4 defaults 1 1 # /dev/sdb2 UUID=075f4d8b-4740-47d8-8fc6-32c56c820a48 /media/usernaem/bigdata ext4 defaults 1 2 # 测试fstab, 没有错误提示，则是正确的 sudo mount -a 解决21版本中wifi无法搜索问题 主要原因：该问题错误出在驱动程序中，以下说明仅适用于Broadcom。  使用命令，删除Broadcom驱动程序： sudo apt remove --purge broadcom-sta* 使用以下命令从Debian软件包（仅buster-backports）下载新版本的驱动程序：  wget http://ftp.ru.debian.org/debian/pool/non-free/b/broadcom-sta/broadcom-sta-common_6.30.223.271-17~bpo10+1_all.deb wget http://ftp.ru.debian.org/debian/pool/non-free/b/broadcom-sta/broadcom-sta-dkms_6.30.223.271-17~bpo10+1_all.deb wget http://ftp.ru.debian.org/debian/pool/non-free/b/broadcom-sta/broadcom-sta-source_6.30.223.271-17~bpo10+1_all.deb 使用以下命令安装驱动程序：  sudo dpkg -i broadcom-sta-common_6.30.223.271-15~bpo10+1_all.deb sudo dpkg -i broadcom-sta-dkms_6.30.223.271-15~bpo10+1_all.deb sudo dpkg -i broadcom-sta-source_6.30.223.271-15~bpo10+1_all.deb  终端颜色重新配置  # 代码注释配色反人类，可以用如下方法解决： /usr/share/terminalwidget5/color-schemes/*.colorschme 54: 24, 24, 178 -- 46, 100, 166。 # 安装terminator/tmux sudo apt install terminator tmux # 测试256色 curl -s https://gist.githubusercontent.com/HaleTom/89ffe32783f89f403bba96bd7bcd1263/raw/ | bash ## 如果不支持，开启 #vim ~/.bashrc #增加命令\"export TERM=xterm-256color\". # 安装插件 fcitx 配置  sudo vim /usr/share/fcitx/configdesc/config.desc [output] 9 安装 krusader/terminator  wget -c https://releases.pagure.org/virt-viewer/virt-viewer-9.0.tar.gz extract virt-viewer-9.0.tar.gz cd virt-viewer-9.0 ./configure --prefix=/usr docker 安装 docker/docker-compose sudo curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun # 安装 docker-compose # debian/centos sudo curl -L \"https://get.daocloud.io/docker/compose/releases/download/1.29.1/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose sudo chmod +x /usr/local/bin/docker-compose # Raspberry sudo apt update -y \u0026\u0026 sudo apt install libffi-dev libssl-dev python3 python3-pip -y sudo pip install docker-compose 修改dockerhub源  参考 Strike Freedom  sudo docker info | grep \"Docker Root Dir\" sudo mkdir -p /home/dockerlib \"data-root\": \"/home/dockerlib/\", \"data-root\": \"/home/share/bkp/lxc_dockers/docker/\", # =17.5 sudo tee /etc/docker/daemon.json { \"registry-mirrors\": [\"https://xxx.mirror.aliyuncs.com\"], \"data-root\": \"/home/dockerlib/\", \"log-driver\":\"json-file\", \"log-opts\":{ \"max-size\" :\"5m\", \"max-file\":\"1\" } } EOF sudo systemctl daemon-reload \u0026\u0026 sudo systemctl restart docker 添加用户组 sudo cat /etc/group | grep docker # 最后的冒号后面没有用户 sudo gpasswd -a ${USER} docker sudo systemctl restart docker 问题排查  socket权限不足  sudo chmod a+rw /var/run/docker.sock sudo systemctl restart docker 卸载 docker stop $(docker ps -aq) \u0026\u0026 docker system prune -a rm /usr/local/bin/docker-compose dpkg -l | grep -i docker apt-get purge -y docker-engine docker docker.io docker-ce docker-ce-cli docker-ce-rootless-extras docker-scan-plugin \u0026\u0026 apt-get autoremove -y --purge docker-engine docker docker.io docker-ce docker-ce-cli docker-ce-rootless-extras docker-scan-plugin apt autoremove \u0026\u0026 apt autoclean rm -rf /var/lib/docker /etc/docker /etc/apparmor.d/docker /var/run/docker.sock \u0026\u0026 groupdel docker 虚拟机  虚拟机安装 openwrt, 参照[最佳实践-树莓派]  ","wordCount":"2087","inLanguage":"en","datePublished":"2022-02-26T18:21:44+08:00","dateModified":"2022-02-26T18:21:44+08:00","author":{"@type":"Person","name":"Suai"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://suai.tk/posts/best_config_linux/"},"publisher":{"@type":"Organization","name":"DataLearning","logo":{"@type":"ImageObject","url":"https://suai.tk/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://suai.tk/ accesskey=h title="Home (Alt + H)">
<img src=https://suai.tk/android-chrome-512x512.png alt=logo aria-label=logo height=22>Home</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://suai.tk/categories/ title=类别>
<span>类别</span>
</a>
</li>
<li>
<a href=https://suai.tk/tags/ title=标签>
<span>标签</span>
</a>
</li>
<li>
<a href=https://suai.tk/archives/ title=归档>
<span>归档</span>
</a>
</li>
<li>
<a href=https://msuai.top title=我的小站>
<span>我的小站</span>
</a>
</li>
<li>
<a href=https://suai.tk/search/ title="搜索 (Alt + /)" accesskey=/>
<span>搜索</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://suai.tk/>Home</a>&nbsp;»&nbsp;<a href=https://suai.tk/posts/>Posts</a></div>
<h1 class=post-title>
最佳实践-Linux环境配置
</h1>
<div class=post-description>
最佳实践：linux下面电脑软件的搭配情况，确保高效、安全
</div>
<div class=post-meta><span title="2022-02-26 18:21:44 +0800 +0800">Sat Feb 26 2022</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;Suai&nbsp;|&nbsp;<a href="mailto://suai_tk@msuai.top?subject=Suggesting%20changes%20for%20/posts/%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-linux%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae.md" rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#%e8%99%9a%e6%8b%9f%e6%9c%ba%e9%9b%86%e7%be%a4 aria-label=虚拟机集群>虚拟机集群</a><ul>
<li>
<a href=#%e5%b8%b8%e8%a7%84%e9%85%8d%e7%bd%ae aria-label=常规配置>常规配置</a><ul>
<li>
<a href=#%e6%8d%a2%e6%ba%90 aria-label=换源>换源</a></li>
<li>
<a href=#%e5%8a%a0%e9%80%9f aria-label=加速>加速</a></li>
<li>
<a href=#%e5%bc%80%e5%90%afssh aria-label=开启ssh>开启ssh</a></li>
<li>
<a href=#%e9%9d%99%e6%80%81-ip aria-label="静态 ip">静态 ip</a></li>
<li>
<a href=#%e5%9f%ba%e7%a1%80%e8%bd%af%e4%bb%b6%e9%85%8d%e7%bd%ae aria-label=基础软件配置>基础软件配置</a></li>
<li>
<a href=#%e7%a9%bf%e9%80%8f%e5%8f%8a%e7%bd%91%e7%bb%9c%e5%ae%89%e5%85%a8 aria-label=穿透及网络安全>穿透及网络安全</a></li>
<li>
<a href=#%e5%8f%af%e9%80%89%e5%ae%89%e8%a3%85-%e5%ad%97%e4%bd%93%e6%b8%a9%e5%ba%a6%e7%9b%91%e6%8e%a7%e7%ad%89 aria-label=可选安装-字体、温度监控等>可选安装-字体、温度监控等</a></li></ul>
</li>
<li>
<a href=#proxmox aria-label=PROXMOX>PROXMOX</a><ul>
<li>
<a href=#%e7%a1%ac%e7%9b%98%e9%85%8d%e7%bd%ae aria-label=硬盘配置>硬盘配置</a></li>
<li>
<a href=#%e5%b7%a5%e5%85%b7%e5%8f%8a%e7%bd%91%e7%bb%9c aria-label=工具及网络>工具及网络</a></li>
<li>
<a href=#lxc%e8%99%9a%e6%8b%9f%e6%9c%ba%e9%85%8d%e7%bd%ae aria-label=lxc虚拟机配置>lxc虚拟机配置</a></li>
<li>
<a href=#win10 aria-label=win10>win10</a></li>
<li>
<a href=#%e5%ae%89%e8%a3%85%e5%a0%a1%e5%9e%92%e6%9c%ba%e6%9a%82%e5%ae%9a aria-label=安装堡垒机(暂定)>安装堡垒机(暂定)</a></li>
<li>
<a href=#%e5%ae%89%e8%a3%85%e6%95%b0%e6%8d%ae%e5%ba%93 aria-label=安装数据库>安装数据库</a></li>
<li>
<a href=#%e5%ae%89%e8%a3%85redis aria-label=安装redis>安装redis</a></li></ul>
</li></ul>
</li>
<li>
<a href=#%e5%8d%95%e6%9c%ba aria-label=单机>单机</a><ul>
<li>
<a href=#deepin aria-label=deepin>deepin</a></li>
<li>
<a href=#docker aria-label=docker>docker</a><ul>
<li>
<a href=#%e5%ae%89%e8%a3%85-dockerdocker-compose aria-label="安装 docker/docker-compose">安装 docker/docker-compose</a></li>
<li>
<a href=#%e4%bf%ae%e6%94%b9dockerhub%e6%ba%90 aria-label=修改dockerhub源>修改dockerhub源</a></li>
<li>
<a href=#%e6%b7%bb%e5%8a%a0%e7%94%a8%e6%88%b7%e7%bb%84 aria-label=添加用户组>添加用户组</a></li>
<li>
<a href=#%e9%97%ae%e9%a2%98%e6%8e%92%e6%9f%a5 aria-label=问题排查>问题排查</a></li>
<li>
<a href=#%e5%8d%b8%e8%bd%bd aria-label=卸载>卸载</a></li></ul>
</li>
<li>
<a href=#%e8%99%9a%e6%8b%9f%e6%9c%ba aria-label=虚拟机>虚拟机</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h1 id=虚拟机集群>虚拟机集群<a hidden class=anchor aria-hidden=true href=#虚拟机集群>#</a></h1>
<h2 id=常规配置>常规配置<a hidden class=anchor aria-hidden=true href=#常规配置>#</a></h2>
<h3 id=换源>换源<a hidden class=anchor aria-hidden=true href=#换源>#</a></h3>
<p>vps 可不用换源</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 更换源</span>
cp -a /etc/apt/sources.list /etc/apt/sources.list.bak

<span style=color:#75715e>## 如果失效，则使用下方的</span>
sed -i <span style=color:#e6db74>&#34;s@http://ftp.debian.org@https://mirrors.tuna.tsinghua.edu.cn@g&#34;</span> /etc/apt/sources.list
sed -i <span style=color:#e6db74>&#34;s@http://security.debian.org@https://mirrors.tuna.tsinghua.edu.cn@g&#34;</span> /etc/apt/sources.list

<span style=color:#75715e># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span>
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free
<span style=color:#75715e># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span>
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free
<span style=color:#75715e># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span>
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free
<span style=color:#75715e># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span>
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free
<span style=color:#75715e># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span>

apt install apt-transport-https ca-certificates
apt update
</code></pre></div><h3 id=加速>加速<a hidden class=anchor aria-hidden=true href=#加速>#</a></h3>
<ol>
<li>github仓库<a href=https://github.com/Chikage0o0/Linux-NetSpeed>Chikage0o0/Linux-NetSpeed: 将Linux现常用的网络加速集成在一起</a></li>
</ol>
<h3 id=开启ssh>开启ssh<a hidden class=anchor aria-hidden=true href=#开启ssh>#</a></h3>
<ol>
<li><code>service ssh status</code>, <a href=https://www.cnblogs.com/lsdb/p/7095288.html>通过配置 hosts.allow 和 hosts.deny 文件允许或禁止 ssh 或 telnet 操作 - 诸子流 - 博客园</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo vim /etc/ssh/sshd_config

Port xxxx
PermitRootLogin yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

<span style=color:#75715e># 不要关闭连接, 在新连接中执行以下语句</span>
systemctl restart sshd.service

<span style=color:#75715e>## 一键替换</span>
sed -i <span style=color:#e6db74>&#34;s/#Port 22/Port 6868/&#34;</span> /etc/ssh/sshd_config
<span style=color:#75715e># sed -i &#34;s/ListenStream=22/ListenStream=6868/&#34; /etc/systemd/system/sockets.target.wants/ssh.socket</span>

<span style=color:#75715e># 传送好密钥，并确保可登录后，再禁用掉密码登录</span>
PasswordAuthentication no
</code></pre></div><ol start=2>
<li>配置密钥
<ol>
<li>清除过旧数据, <code>ssh-keygen -R [172.20.16.163]:xxx</code></li>
<li>添加ssh登录密钥</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># C:/Users/username/.ssh/config</span>
<span style=color:#75715e># ~/.ssh/config</span>
Host lxc_centos
    HostName 192.168.31.xxx
    User root
    Port xxx
    IdentityFile <span style=color:#e6db74>&#34;~/.ssh/lxc_rsa&#34;</span>
</code></pre></div><ol start=3>
<li>通用配置方式</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>NAME_IDRSA<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx@xxx.nas&#34;</span>
FILE_IDRSA<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:/Users/username/.ssh/pve/xxx_rsa&#34;</span>
PORT<span style=color:#f92672>=</span>xxx
IP_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;root@192.168.31.xxx&#34;</span>

ssh-keygen -t rsa -C <span style=color:#e6db74>${</span>NAME_IDRSA<span style=color:#e6db74>}</span> -f <span style=color:#e6db74>${</span>FILE_IDRSA<span style=color:#e6db74>}</span>
ssh-copy-id -i <span style=color:#e6db74>${</span>FILE_IDRSA<span style=color:#e6db74>}</span> -p <span style=color:#e6db74>${</span>PORT<span style=color:#e6db74>}</span> <span style=color:#e6db74>${</span>IP_ADDR<span style=color:#e6db74>}</span>
</code></pre></div><ol start=4>
<li>问题解决</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#sign_and_send_pubkey: signing failed: agent refused operation</span>
ssh-add cc8 deepin centos
ssh-add -l

<span style=color:#75715e># WARNING: UNPROTECTED PRIVATE KEY FILE!, too open</span>
sudo chmod <span style=color:#ae81ff>700</span> <span style=color:#e6db74>&#39;.ssh/*id_rsa&#39;</span>
</code></pre></div></li>
</ol>
<h3 id=静态-ip>静态 ip<a hidden class=anchor aria-hidden=true href=#静态-ip>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cp /etc/network/interfaces /etc/network/interfaces.bkp
vim /etc/network/interfaces

auto ensXX
iface ensXX inet static
  address 192.168.31.xxx
  netmask 255.255.255.0
  <span style=color:#75715e># 设置网关</span>
  <span style=color:#75715e># gateway 192.168.31.2</span>
  gateway 192.168.31.1
  dns-nameservers 192.168.31.x 192.168.31.1

apt install resolvconf
cp -p /etc/resolvconf/resolv.conf.d/head /etc/resolvconf/resolv.conf.d/head.orig
vim /etc/resolvconf/resolv.conf.d/head

nameserver 192.168.31.2
nameserver 192.168.31.1
<span style=color:#75715e># nameserver 8.8.8.8</span>
<span style=color:#75715e># nameserver 114.114.114.114</span>

systemctl restart networking.service
reboot <span style=color:#75715e># init 6</span>
</code></pre></div><h3 id=基础软件配置>基础软件配置<a hidden class=anchor aria-hidden=true href=#基础软件配置>#</a></h3>
<ol>
<li>安装基本软件</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 更新</span>
apt update -y <span style=color:#f92672>&amp;&amp;</span> apt install sudo -y
apt upgrade -y

sudo apt install -y git vim wget screen curl dnsutils
<span style=color:#75715e># sudo vim /etc/vim/vimrc</span>
tee -a /etc/vim/vimrc<span style=color:#e6db74>&lt;&lt;EOF
</span><span style=color:#e6db74>syntax on
</span><span style=color:#e6db74>set smartcase
</span><span style=color:#e6db74>set number
</span><span style=color:#e6db74>set shiftwidth=4
</span><span style=color:#e6db74>set tabstop=4
</span><span style=color:#e6db74>set expandtab
</span><span style=color:#e6db74>EOF</span>

<span style=color:#75715e># vim paste 格式错乱</span>
1. 先设定, <span style=color:#e6db74>`</span>set paste<span style=color:#e6db74>`</span>
2. 插入模式，粘贴
</code></pre></div><ol start=2>
<li>禁用启动项</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemd-analyze blame

systemctl disable pve-daily-update.service

systemctl disable apt-daily.service
systemctl disable apt-daily-upgrade.service
</code></pre></div><ol start=3>
<li>配置 swap</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo swapon --show

sudo fallocate -l 1G /swapfile
sudo chmod <span style=color:#ae81ff>600</span> /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

sudo vi /etc/fstab
/swapfile swap swap defaults <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>

sudo swapon --show

<span style=color:#75715e># 关闭swap</span>
sudo swapoff -a
vim /etc/fstab, 注释掉swap
</code></pre></div><ol start=4>
<li>设置时间、时区、本地化</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt install ntpdate locales -y
sudo ntpdate time.windows.com

sudo dpkg-reconfigure tzdata
sudo dpkg-reconfigure locales

<span style=color:#75715e># 或者编辑文件</span>
sudo vim /etc/locale.gen <span style=color:#75715e>#zh_CN.UTF-8</span>
sudo locale-gen
localectl set-locale LANG<span style=color:#f92672>=</span>zh_CN.UTF-8
</code></pre></div><ol start=5>
<li>使用zsh&zinit, 见<a href=https://suai.tk/posts/best_zsh/>最佳实践-ZSH</a></li>
</ol>
<h3 id=穿透及网络安全>穿透及网络安全<a hidden class=anchor aria-hidden=true href=#穿透及网络安全>#</a></h3>
<ol>
<li>
<p>zerotier, 局域网内不需要每个都安装, openwrt可开启nat</p>
<ol>
<li>常规安装</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>## 安装</span>
curl -s https://install.zerotier.com | sudo bash
<span style=color:#75715e># 如果没有任何反应，可能是因为代理的原因</span>
<span style=color:#75715e># 关闭代理，然后source ~/.zshrc</span>
sudo zerotier-cli join 6****
sudo systemctl enable zerotier-one

https://my.zerotier.com/network/6***

<span style=color:#75715e># 如果无法使用systemctl,则添加重启脚本如下</span>
sudo vim /etc/rc.local
zerotier-one -d
</code></pre></div><ol start=2>
<li>lxc中无法直接是用zerotier。<code>lxc zerotier-one[127]: ERROR: unable to configure virtual network port: could not open TUN/TAP device: No such file or directory</code></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vim /etc/pve/lxc/105.conf

lxc.cgroup.devices.allow <span style=color:#f92672>=</span> c 10:200 rwm
lxc.hook.autodev <span style=color:#f92672>=</span> sh -c <span style=color:#e6db74>&#34;modprobe tun; cd </span><span style=color:#e6db74>${</span>LXC_ROOTFS_MOUNT<span style=color:#e6db74>}</span><span style=color:#e6db74>/dev; mkdir net; mknod net/tun c 10 200; chmod 0666 net/tun&#34;</span>
</code></pre></div><ol start=3>
<li>zerotier安装在旁路由, 参照里面设置：<a href=https://koolshare.cn/thread-152561-1-1.html>LEDE旁路由中安装zerotier，内网穿透，访问局域网，极简教程 - LEDE/OpenWRT - KoolShare - 源于玩家 服务玩家</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ztklhszno7

iptables -I FORWARD -i ztklhszno7 -j ACCEPT
iptables -I FORWARD -o ztklhszno7 -j ACCEPT
iptables -t nat -I POSTROUTING -o ztklhszno7 -j MASQUERADE

修改工作机的dns为旁路由，即可使用旁路由的局域网域名
</code></pre></div><ol start=4>
<li>卸载</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 通过dpkg删除zerotier-one服务</span>
dpkg -P zerotier-one
<span style=color:#75715e># 删除zerotier-one文件夹，该文件夹存储了address地址，删除后再次安装会获得新的address地址</span>
rm -rf /var/lib/zerotier-one/
</code></pre></div><ol start=5>
<li>ZEROTIER使用指引</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>https://XX.xxx.top/login?redirect<span style=color:#f92672>=</span>%2Ffiles%2F

1. 安装zerotier软件
2. 加入 6***
3. 在任务栏的搜索框中，键入“远程桌面连接”，然后选择“远程桌面连接”。
4. 计算机：192.168.31.XXX:3389, 连接
5. 用户名：username，密码：password
</code></pre></div></li>
<li>
<p>ufw</p>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt install ufw -y

ufw status|enable|disable|reset

<span style=color:#75715e># 开放端口</span>
<span style=color:#75715e># 允许端口22[80|443]上的所有链接</span>
ufw allow ssh<span style=color:#f92672>[</span>http|https<span style=color:#f92672>]</span>
<span style=color:#75715e># 非正常端口</span>
ufw allow <span style=color:#ae81ff>6868</span>

ufw allow 80/tcp
ufw allow 21/udp
ufw allow 9000:9010/tcp
ufw allow<span style=color:#f92672>[</span>deny<span style=color:#f92672>]</span> from 192.168.31.182<span style=color:#f92672>[</span>0/24<span style=color:#f92672>]</span>
ufw allow from 192.168.31.182 to any port <span style=color:#ae81ff>80</span> <span style=color:#f92672>[</span>protol tcp/udp<span style=color:#f92672>]</span>

ufw status verbose

ufw deny <span style=color:#ae81ff>80</span>

ufw delete allow http
ufw delete deny <span style=color:#ae81ff>22</span>
</code></pre></div><ol start=3>
<li>fail2ban</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt install fail2ban -y

cp /etc/fail2ban/fail2ban.conf /etc/fail2ban/fail2ban.local

ignoreip <span style=color:#f92672>=</span> 127.0.0.1/8  ::1 192.168.31.0/24
<span style=color:#75715e># /etc/fail2ban</span>
<span style=color:#75715e># fail2ban.conf ：配置文件里面定义了fail2ban记录的日志等级、日志文件的位置以及socket。</span>
<span style=color:#75715e># jail.conf 里面定义了对那些服务进行监控，以及使用的一些策略。</span>

apt-get install fail2ban

<span style=color:#75715e>#启动&amp;开机自启</span>
systemctl start fail2ban.service
systemctl enable fail2ban.service
</code></pre></div><ol start=4>
<li>clamav, 参考<a href=https://wiki.ubuntu.org.cn/ClamAV>ClamAV - Ubuntu中文</a></li>
</ol>
<h3 id=可选安装-字体温度监控等>可选安装-字体、温度监控等<a hidden class=anchor aria-hidden=true href=#可选安装-字体温度监控等>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt install psensor

apt install fonts-firacode fonts-wqy-zenhei -y
fc-list | awk <span style=color:#e6db74>&#39;{$1=&#34;&#34;}1&#39;</span> | cut -d: -f1 | sort| uniq
Fira Code Retina
</code></pre></div><h2 id=proxmox>PROXMOX<a hidden class=anchor aria-hidden=true href=#proxmox>#</a></h2>
<h3 id=硬盘配置>硬盘配置<a hidden class=anchor aria-hidden=true href=#硬盘配置>#</a></h3>
<ol>
<li><a href=https://wangxingcs.com/2020/0910/1442/>Proxmox VE（PVE）添加硬盘 - 星哥的博客</a></li>
</ol>
<h3 id=工具及网络>工具及网络<a hidden class=anchor aria-hidden=true href=#工具及网络>#</a></h3>
<ol>
<li>pvetools工具，<a href=https://github.com/ivanhao/pvetools>ivanhao/pvetools</a></li>
<li>为pve增加ipv6，<a href=https://www.simonmott.co.uk/2018/06/dual-stacking-proxmox-web-ui-pveproxy/>增加 ipve6</a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>## 开启IPV6</span>
vim /etc/hosts

-- 10.0.0.100 pvehost.some.domain pvehost pvelocalhost
++ ::ffff:10.0.0.100 pvehost.some.domain pvehost pvelocalhost

systemctl restart pveproxy.service
<span style=color:#75715e># tcp6       0      0 :::8006                 :::*                    LISTEN      -</span>
</code></pre></div></li>
<li><a href=https://www.10bests.com/dsm-hdd-hibernation-on-pve/>Promox VE(PVE)安装虚拟黑群晖实现硬盘休眠避坑指南 - 十佳测评</a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ata-ST3000DM008_Z294S0UH -&gt; ../../sdb

qm set <span style=color:#ae81ff>100</span> --sata0 /dev/disk/by-id/ata-ST3000DM008_Z294S0UH
</code></pre></div></li>
</ol>
<h3 id=lxc虚拟机配置>lxc虚拟机配置<a hidden class=anchor aria-hidden=true href=#lxc虚拟机配置>#</a></h3>
<ol>
<li>安装lxc相关
<ol>
<li>配置 lxc 源, 或者访问<a href=https://mirrors.ustc.edu.cn/proxmox/images/system/>系统</a>, <a href=https://mirrors.ustc.edu.cn/turnkeylinux/images/proxmox/>其它软件</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>grep -rn <span style=color:#e6db74>&#34;download.proxmox.com&#34;</span> /usr/share/perl5/PVE/*   <span style=color:#75715e>#查找设定下载源的文件</span>
sed -i.bak <span style=color:#e6db74>&#34;s#http://download.proxmox.com/images#https://mirrors.ustc.edu.cn/proxmox/images#g&#34;</span> /usr/share/perl5/PVE/APLInfo.pm
wget -O /var/lib/pve-manager/apl-info/mirrors.ustc.edu.cn https://mirrors.ustc.edu.cn/proxmox/images/aplinfo-pve-6.dat
</code></pre></div><ol start=2>
<li>使用第三方的lxc镜像。<a href=https://www.cxthhhhh.com/2020/11/07/system-image-debian-10-lxc-ovz-latest-template-v1-3-ssh-enabled-time-zone-optimized.html>【系统镜像】Debian 10 LXC/OVZ 最新模板 v1.3（开启 SSH、时区、优化） - CXT - Enjoy Life | 生活、技术、交友、分享</a></li>
<li>安装完成后，配置好linux环境，备份成lxc模板</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 包含了配置好的源、docker、本地化、ssh、字体等等，zsh, ufw</span>
/mnt/pve/Media/dump/vzdump-lxc-initial-debian-20210702.tar.gz
</code></pre></div><ol start=4>
<li>安装 lxc, 参考 <a href="http://www.gienginali.idv.tw/modules/tad_book3/page.php?tbsn=19&tbdsn=792">gienginali - 複製 LXC 虛擬機</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd /mnt/sdb/images
cp -r <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>210</span>
cd <span style=color:#ae81ff>210</span> <span style=color:#f92672>&amp;&amp;</span> mv vm-200-disk-0.raw vm-210-disk-0.raw

cd /etc/pve/nodes/pve/lxc
cp 200.conf 210.conf

<span style=color:#75715e># restore 到113, 无特权的√取消</span>
vim 210.conf

<span style=color:#75715e># 进行网段扫描，去掉被占用的ip</span>
apt install nmap
nmap -sP 192.168.31.0/24
cat /proc/net/arp
<span style=color:#75715e># [在线MAC地址生成器-在线工具](http://www.metools.info/other/o66.html)</span>

<span style=color:#75715e># 进行ip、mac、硬盘等修改</span>
rootfs: sdb:210/vm-210-disk-0.raw,size<span style=color:#f92672>=</span>16G
mp0: /mnt/pve/Media/share,mp<span style=color:#f92672>=</span>/home/share

<span style=color:#75715e># 打开选项-功能-嵌套、NFS、smb/cifs</span>
</code></pre></div><ol start=4>
<li>挂载 pve 目录，强制关闭虚拟机</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#pct set 104 -mp0 /mnt/pve/Media/share,mp=/home/share</span>
qm stop 101; sleep 3; qm start <span style=color:#ae81ff>101</span>
</code></pre></div><ol start=5>
<li>修改motd、hostname、ssh端口</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vim /etc/motd
vim /etc/hostname
<span style=color:#75715e># 修改ssh端口后，ssh开机不自动启动</span>
sed -i <span style=color:#e6db74>&#34;s/#Port 22/Port 12345/&#34;</span> /etc/ssh/sshd_config
sed -i <span style=color:#e6db74>&#34;s/ListenStream=22/ListenStream=12345/&#34;</span> /etc/systemd/system/sockets.target.wants/ssh.socket
</code></pre></div><ol start=6>
<li>无法使用docker，<code>operation cps</code>。参考<a href=https://danthesalmon.com/running-docker-on-proxmox/>Running Docker on Proxmox - Dan [the] Salmon</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># In Proxmox, edit the /etc/pve/lxc/&lt;id&gt;.conf file where &lt;id&gt; is the ID given to your container:</span>
lxc.apparmor.profile: unconfined
lxc.cgroup.devices.allow: a
lxc.cap.drop:
</code></pre></div></li>
</ol>
<h3 id=win10>win10<a hidden class=anchor aria-hidden=true href=#win10>#</a></h3>
<ol>
<li>安装虚拟机</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mstsc

qm importdisk <span style=color:#ae81ff>101</span> /var/lib/vz/images/win10.qcow2 Media
<span style=color:#75715e># virio block</span>
</code></pre></div><ol start=2>
<li>直通 usb</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dmesg | grep <span style=color:#e6db74>&#39;usb&#39;</span>
<span style=color:#75715e># 记下要直通的usb序号, 编辑虚拟机conf文件</span>
echo <span style=color:#e6db74>&#34;usb0: host=2-1.4&#34;</span> &gt;&gt; /etc/pve/qemu-server/101.conf

qm stop 101;sleep 3; qm start <span style=color:#ae81ff>101</span>
</code></pre></div><ol start=3>
<li>spice 配置
参考：<a href="https://blog.csdn.net/weixin_42077546/article/details/106984128?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control">proxmox VE 安装 Windows 虚拟机（包括 virtIO 驱动）及 SPICE 远程桌面配置_墨问西东的博客-CSDN 博客</a>
<code>spice://192.168.31.184:60002</code>,<code>password</code>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#远程界面选择服务器节点pve1，选择shell，cd到/etc/pve/qemu-server目录下，服务器上安装的虚拟机配置文件均在此目录下。在虚拟机配置文件中添加一下内容（如100.conf）：</span>
z qemu<span style=color:#f92672>(</span>cd /etc/pve/nodes/pve/qemu-server<span style=color:#f92672>)</span>
args: -spice port<span style=color:#f92672>=</span>61003,addr<span style=color:#f92672>=</span>0.0.0.0,password<span style=color:#f92672>=</span>password,seamless-migration<span style=color:#f92672>=</span>on
<span style=color:#75715e>#其中，-spice即为配置SPICE；</span>
<span style=color:#75715e>#port为监听端口，一般应大于61001；</span>
<span style=color:#75715e>#addr为容许网络，设置为0.0.0.0为允许任何网络连接；</span>
<span style=color:#75715e>#disable-ticketing为去掉密码验证，如需加密码验证，将此参数改为password=xxxx；</span>
<span style=color:#75715e>#seamless-migration=on为QMP支持。</span>
<span style=color:#75715e>#设置完毕后在SPICE client端输入spice://ip:61002就可以正常远程连接了。</span>
</code></pre></div></li>
</ol>
<h3 id=安装堡垒机暂定>安装堡垒机(暂定)<a hidden class=anchor aria-hidden=true href=#安装堡垒机暂定>#</a></h3>
<h3 id=安装数据库>安装数据库<a hidden class=anchor aria-hidden=true href=#安装数据库>#</a></h3>
<ol>
<li>只允许本地局域网连接,
<ol>
<li><code>ufw allow from 192.168.31.0/24 to any port 6868,3306,6379 proto tcp</code></li>
<li><code>ufw allow from 192.168.31.0/24 to any port 6380,6381 proto tcp</code></li>
</ol>
<pre tabindex=0><code class=language-bah data-lang=bah>❯ netstat -tnl
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:6868            0.0.0.0:*               LISTEN
tcp        0      0 172.17.0.1:24731        0.0.0.0:*               LISTEN
</code></pre></li>
<li>mysql官网，<a href="https://dev.mysql.com/downloads/file/?id=509020">MySQL :: Begin Your Download</a></li>
<li>安装 mysql
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 检测是否安装过mysql</span>
dpkg -l | grep mysql
<span style=color:#75715e># 下载mysql配置源</span>
wget -c https://dev.mysql.com/get/mysql-apt-config_0.8.16-1_all.deb
<span style=color:#75715e># 检测md5</span>
sudo md5sum mysql-apt-config_0.8.16-1_all.deb

dpkg -i mysql-apt-config_0.8.16-1_all.deb
<span style=color:#75715e># 选择8.0及相关tools</span>
<span style=color:#75715e># 低配置情况下，选择5.7</span>
apt update

apt install mysql-server -y
</code></pre></div></li>
<li>创建数据库、授权
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql -uroot -p -e <span style=color:#e6db74>&#34;show databases;&#34;</span>
<span style=color:#75715e># wzd2GEAKQAJBr7cHsVJoaiu6</span>
DB_PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 24<span style=color:#e6db74>`</span>
echo -e <span style=color:#e6db74>&#34;\033[31m 你的数据库密码是 </span>$DB_PASSWORD<span style=color:#e6db74> \033[0m&#34;</span>
mysql -uroot -p -e <span style=color:#e6db74>&#34;create database if not exists chevereto default charset &#39;utf8&#39;; create user &#39;chv_lxc&#39;@&#39;192.168.31.175&#39; identified with mysql_native_password by &#39;</span>$DB_PASSWORD<span style=color:#e6db74>&#39;; grant all privileges on chevereto.* to &#39;chv_lxc&#39;@&#39;192.168.31.175&#39; with grant option; flush privileges;&#34;</span>
<span style=color:#75715e># mysql -uroot -p -e &#34;alter user &#39;chv_lxc&#39;@&#39;192.168.31.175&#39; identified with mysql_native_password by &#39;$DB_PASSWORD&#39;;&#34;</span>

mysql -uroot -p -e <span style=color:#e6db74>&#34;rename user &#39;jmp_lxc&#39;@&#39;192.168.31.176&#39; to &#39;jmp_lxc&#39;@&#39;192.168.31.100&#39;;grant all privileges on jumpserver.* to &#39;jmp_lxc&#39;@&#39;192.168.31.100&#39; with grant option; flush privileges;&#34;</span>
mysql -uroot -p -e <span style=color:#e6db74>&#34;alter user &#39;jmp_lxc&#39;@&#39;192.168.31.176&#39; identified with mysql_native_password by &#39;</span>$DB_PASSWORD<span style=color:#e6db74>&#39;;&#34;</span>
mysql -uroot -p -e <span style=color:#e6db74>&#34;alter database jumpserver character set &#39;utf8&#39;;&#34;</span>
</code></pre></div></li>
<li>数据迁移, <a href=https://humingk.github.io/mysql-path/>MySQL 修改默认存储路径 — 小明也来过的个人博客</a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl stop mysql.service

<span style=color:#75715e># 进行备份</span>
cp -a -R /var/lib/mysql /home/share/bkp 

<span style=color:#75715e># 修改配置文件</span>
vim /etc/mysql/mysql.conf.d/mysqld.cnf

datadir <span style=color:#f92672>=</span> /home/share/bkp/mysql

mysql -uroot -p -e <span style=color:#e6db74>&#34;show global variables like &#39;%datadir%&#39;;&#34;</span>

mysqldump -h 10.1.2.24 -P <span style=color:#ae81ff>3306</span> -u esm-tmp -p -d mocha &gt; dump.txt
/usr/local/mysql/bin/mysqldump -uroot -p -d abc &gt; abc.sql
</code></pre></div></li>
<li>彻底删除
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 彻底删除mysql</span>
dpkg --get-selections | grep mysql

apt autoremove mysql-community-server mysql-community-client mysql-common mysql-client mysql-server --purge
rm /etc/mysql/ -R <span style=color:#f92672>&amp;&amp;</span> rm /var/lib/mysql/ -R

<span style=color:#75715e>#apt autoremove apparmor -y</span>
apt autoremove <span style=color:#f92672>&amp;&amp;</span> apt autoclean
</code></pre></div></li>
<li>连接wsl的mysql
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
<span style=color:#75715e># bind-addr 注释掉</span>
sudo service mysql start

<span style=color:#75715e># 增加开机启动</span>
vim /etc/init.wsl
<span style=color:#75715e>#! /bin/sh</span>
/etc/init.d/ssh $1
/etc/init.d/mysql $1
</code></pre></div></li>
<li>mysql问题解决
<ol>
<li>如果出现了错误：ERROR 2002 (HY000): Can&rsquo;t connect to local MySQL server through socket &lsquo;/var/run/mysqld/mysqld.sock&rsquo; (2)</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vim /etc/mysql/my.conf
<span style=color:#f92672>[</span>mysqld<span style=color:#f92672>]</span>
skip-grant-tables

systemctl restart mysql
mysql -uroot -p
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>flush <span style=color:#66d9ef>privileges</span>;
<span style=color:#66d9ef>set</span> password <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;root&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;localhost&#39;</span><span style=color:#f92672>=</span>password(<span style=color:#e6db74>&#39;****&#39;</span>);
<span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>ALL</span> <span style=color:#66d9ef>PRIVILEGES</span> <span style=color:#66d9ef>ON</span> <span style=color:#f92672>*</span>.<span style=color:#f92672>*</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;root&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;****&#39;</span> <span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>OPTION</span>;

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>USER</span> <span style=color:#e6db74>&#39;root&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;PASSWORD&#39;</span>;
<span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>ALL</span> <span style=color:#66d9ef>PRIVILEGES</span> <span style=color:#66d9ef>ON</span> <span style=color:#f92672>*</span>.<span style=color:#f92672>*</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;root&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span> <span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>OPTION</span>;
</code></pre></div></li>
</ol>
<h3 id=安装redis>安装redis<a hidden class=anchor aria-hidden=true href=#安装redis>#</a></h3>
<ol>
<li>
<p>安装 redis, 打开选项-功能-嵌套、NFS、smb/cifs</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt install redis-server -y

redis-cli

<span style=color:#75715e>### 2021年12月28日 星期二 redis启动失败，后面无法继续</span>

CONFIG get requirepass
CONFIG set requirepass <span style=color:#e6db74>&#34;passwd&#34;</span>
auth <span style=color:#e6db74>&#34;passwd&#34;</span>

vim /etc/redis/redis.conf
bind 127.0.0.1 192.168.31.126 192.168.31.200 192.168.31.201 192.168.31.202 192.168.31.210 192.168.31.211
requirepass passwd
systemctl restart redis-server.service
</code></pre></div></li>
<li>
<p>问题解决</p>
<ol>
<li>echo never</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>593:M <span style=color:#ae81ff>02</span> Jul <span style=color:#ae81ff>2021</span> 22:58:31.054 <span style=color:#75715e># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory = 1&#39; to /etc/sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory=1&#39; for this to take effect.</span>
593:M <span style=color:#ae81ff>02</span> Jul <span style=color:#ae81ff>2021</span> 22:58:31.054 <span style=color:#75715e># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#39; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span>

never
echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
always <span style=color:#f92672>[</span>madvise<span style=color:#f92672>]</span> never
</code></pre></div><ol start=2>
<li>pid文件</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># redis, status, 提示没有pid文件</span>
vim /etc/systemd/system/redis.service

<span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
Type<span style=color:#f92672>=</span>forking
ExecStart<span style=color:#f92672>=</span>/usr/bin/redis-server /etc/redis/redis.conf
ExecStop<span style=color:#f92672>=</span>/bin/kill -s TERM $MAINPID
<span style=color:#75715e>## 增加下面一行</span>
ExecStartPost<span style=color:#f92672>=</span>/bin/sh -c <span style=color:#e6db74>&#34;echo </span>$MAINPID<span style=color:#e6db74> &gt; /var/run/redis/redis.pid&#34;</span>
PIDFile<span style=color:#f92672>=</span>/run/redis/redis-server.pid
</code></pre></div><ol start=3>
<li>Jumpyserver
jumpserver logs 一直在wait redis</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>## 升级redis到最新版本, lxc_debian,测试失败</span>
<span style=color:#75715e># redis-server --version</span>
<span style=color:#75715e># apt update -y &amp;&amp; apt upgrade -y</span>
<span style=color:#75715e># cp /etc/redis/redis.conf ~/redis.conf.bkp</span>
<span style=color:#75715e># export ALL_PROXY=socks5://192.168.31.2:10068</span>
<span style=color:#75715e># unset ALL_PROXY</span>
<span style=color:#75715e># wget -N https://raw.githubusercontent.com/Websoft9/ansible-linux/main/scripts/install.sh; bash install.sh -r redis</span>

</code></pre></div></li>
<li>
<p>配置哨兵模式, 配置并启动主从</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cp /etc/redis/redis.conf /etc/redis/redis-6380.conf
cp /etc/redis/redis.conf /etc/redis/redis-6381.conf

vim /etc/redis/redis-638*.conf
port 638*
pidfile /var/run/redis/redis-638*.pid
logfile /var/log/redis/redis-638*.log

replicaof 127.0.0.1 <span style=color:#ae81ff>6379</span>
masterauth nhsVU9z6T&amp;YHH&amp;

redis-server /etc/redis/redis-638*.conf
<span style=color:#75715e>## 查看是否配置成功</span>
redis-cli
&gt; auth nhsVU9z6T&amp;YHH&amp;
&gt; info Replication

<span style=color:#75715e># 配置并启动哨兵</span>
vim /etc/redis/sentinel-16379.conf

port <span style=color:#ae81ff>16379</span>
daemonize yes
dir /var/run/redis/sentinel
pidfile /var/run/redis/sentinel/redis-sentinel-16379.pid

sentinel monitor mymaster 127.0.0.1 <span style=color:#ae81ff>6379</span> <span style=color:#ae81ff>2</span>
sentinel auth-pass mymaster nhsVU9z6T&amp;YHH&amp;
sentinel down-after-milliseconds mymaster <span style=color:#ae81ff>5000</span>
sentinel parallel-syncs mymaster <span style=color:#ae81ff>1</span>
sentinel failover-timeout mymaster <span style=color:#ae81ff>15000</span>

cp /etc/redis/sentinel-16379.conf /etc/redis/sentinel-16380.conf
cp /etc/redis/sentinel-16379.conf /etc/redis/sentinel-16381.conf

redis-server /etc/redis/redis-6380.conf <span style=color:#f92672>&amp;&amp;</span> redis-server /etc/redis/redis-6381.conf
redis-server /etc/redis/sentinel-16379.conf --sentinel <span style=color:#f92672>&amp;&amp;</span> redis-server /etc/redis/sentinel-16380.conf --sentinel <span style=color:#f92672>&amp;&amp;</span> redis-server /etc/redis/sentinel-16381.conf --sentinel

<span style=color:#75715e>## 以下未试验成功</span>
echo “/opt/redis/src/redis-sentinel /main/redis/sentinel.conf” &gt;&gt; /etc/rc.local
/usr/bin/redis-server /etc/redis/redis-6379.conf
/usr/bin/redis-server /etc/redis/redis-6380.conf
/usr/bin/redis-server /etc/redis/redis-6381.conf
/usr/bin/redis-server /etc/redis/sentinel-16379.conf --sentinel
/usr/bin/redis-server /etc/redis/sentinel-16380.conf --sentinel
/usr/bin/redis-server /etc/redis/sentinel-16381.conf --sentinel
</code></pre></div></li>
<li>
<p>keepalived, 未成功</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt install keepalived

vim /etc/keepalived/check_redis.sh

<span style=color:#75715e>#!/bin/bash</span>
&lt;/dev/tcp/127.0.0.1/6379

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    REDIS_PASSWD<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;nhsVU9z6T&amp;YHH&amp;&#39;</span>
    ROLE<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>redis-cli -a <span style=color:#e6db74>${</span>REDIS_PASSWD<span style=color:#e6db74>}</span> info replication | grep role<span style=color:#e6db74>`</span>
    MASTER<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>echo -e <span style=color:#e6db74>&#34;role:master\r\n&#34;</span><span style=color:#e6db74>`</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$ROLE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;</span>$MASTER<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
                exit <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>fi</span>

    <span style=color:#75715e># MASTERIP=`ip add | grep 192.168.31.20 | wc -l`</span>
    <span style=color:#75715e># if [ $MASTERIP -eq 0 ]; then</span>
    <span style=color:#75715e>#             exit 0</span>
    <span style=color:#75715e>#     fi</span>
<span style=color:#66d9ef>fi</span>
exit <span style=color:#ae81ff>1</span>

<span style=color:#75715e># 编写 Redis 集群切换邮件通知脚本，修改通知标题及正文内容</span>
cp /etc/keepalived/email_tengine.sh /etc/keepalived/email_redis.sh
vi  /etc/keepalived/email_redis.sh

<span style=color:#75715e>#!/bin/bash</span>
contact<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;redis@xxx.top&#39;</span>
notify<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    mailsubject<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[Devops Redis VIP 切换] </span><span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span><span style=color:#e6db74> -&gt; </span>$1<span style=color:#e6db74>&#34;</span>
    mailbody<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[</span><span style=color:#66d9ef>$(</span>date +<span style=color:#e6db74>&#39;%F %T&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>]: Devops Redis VIP 切换, </span><span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span><span style=color:#e6db74> 切换为 </span>$1<span style=color:#e6db74> ！&#34;</span>
    echo <span style=color:#e6db74>&#34;</span>$mailbody<span style=color:#e6db74>&#34;</span> | mail -s <span style=color:#e6db74>&#34;</span>$mailsubject<span style=color:#e6db74>&#34;</span> $contact
<span style=color:#f92672>}</span>
<span style=color:#66d9ef>case</span> $1 in
master<span style=color:#f92672>)</span>
    notify master
    ;;
backup<span style=color:#f92672>)</span>
    notify backup
    ;;
fault<span style=color:#f92672>)</span>
    notify fault
    ;;
*<span style=color:#f92672>)</span>
    echo <span style=color:#e6db74>&#34;Usage: </span><span style=color:#66d9ef>$(</span>basename $0<span style=color:#66d9ef>)</span><span style=color:#e6db74> {master|backup|fault}&#34;</span>
    exit <span style=color:#ae81ff>1</span>
    ;;
<span style=color:#66d9ef>esac</span>

<span style=color:#75715e># 修改keepalived配置，添加一个新的VRRP实例，并添加相关的状态检查脚本</span>
<span style=color:#75715e># 注意 keepalived 3个节点须工作在非抢占模式下，角色均设置为BACKUP，优先级相同。</span>
vi /etc/keepalived/keepalived.conf

vrrp_script chk_redis <span style=color:#f92672>{</span>
    script <span style=color:#e6db74>&#34;/etc/keepalived/check_redis.sh&#34;</span>
    interval <span style=color:#ae81ff>1</span>
<span style=color:#f92672>}</span>

vrrp_instance VI_REDIS <span style=color:#f92672>{</span>
    state BACKUP
    nopreempt
    interface bond-app
    virtual_router_id <span style=color:#ae81ff>52</span>
    priority <span style=color:#ae81ff>100</span>
    advert_int <span style=color:#ae81ff>1</span>
    authentication <span style=color:#f92672>{</span>
        auth_type PASS
        auth_pass xxxxxxxx
    <span style=color:#f92672>}</span>
    virtual_ipaddress <span style=color:#f92672>{</span>
        10.255.200.4/24
    <span style=color:#f92672>}</span>
    track_script <span style=color:#f92672>{</span>
        chk_redis
    <span style=color:#f92672>}</span>

    notify_master <span style=color:#e6db74>&#34;/etc/keepalived/email_redis.sh master&#34;</span>
    notify_backup <span style=color:#e6db74>&#34;/etc/keepalived/email_redis.sh backup&#34;</span>
    notify_fault <span style=color:#e6db74>&#34;/etc/keepalived/email_redis.sh fault&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div></li>
</ol>
<h1 id=单机>单机<a hidden class=anchor aria-hidden=true href=#单机>#</a></h1>
<h2 id=deepin>deepin<a hidden class=anchor aria-hidden=true href=#deepin>#</a></h2>
<ol>
<li>安装系统盘，数据盘不要安装，后续再进行分区，然后挂载</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git config --global user.name <span style=color:#e6db74>&#34;username&#34;</span>
git config --global user.email <span style=color:#e6db74>&#34;username@deepin&#34;</span>
</code></pre></div><ol start=2>
<li>优化启动</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemd-analyze blame

systemctl disable<span style=color:#f92672>[</span>mask<span style=color:#f92672>]</span>
systemctl disable apt-daily.service
<span style=color:#75715e># NetworkManager-wait-online.service</span>
</code></pre></div><ol start=3>
<li>全盘备份, 定时备份（timemachie)</li>
<li>系统优化</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 进行挂载重命名</span>
sudo e2label /dev/sdb1 <span style=color:#e6db74>&#34;Backup&#34;</span>
sudo e2label /dev/sdb2 <span style=color:#e6db74>&#34;Bigdata&#34;</span>

<span style=color:#75715e># /dev/sdb1</span>
UUID<span style=color:#f92672>=</span>f20f1458-cd6e-4e5b-be8c-a871045fc7b8 /media/usernaem/backup ext4 defaults <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>
<span style=color:#75715e># /dev/sdb2</span>
UUID<span style=color:#f92672>=</span>075f4d8b-4740-47d8-8fc6-32c56c820a48 /media/usernaem/bigdata ext4 defaults <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span>

<span style=color:#75715e># 测试fstab, 没有错误提示，则是正确的</span>
sudo mount -a
</code></pre></div><ol start=5>
<li>解决21版本中wifi无法搜索问题
主要原因：该问题错误出在驱动程序中，以下说明仅适用于Broadcom。
<ol>
<li>使用命令，删除Broadcom驱动程序： <code>sudo apt remove --purge broadcom-sta*</code></li>
<li>使用以下命令从Debian软件包（仅buster-backports）下载新版本的驱动程序：</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget http://ftp.ru.debian.org/debian/pool/non-free/b/broadcom-sta/broadcom-sta-common_6.30.223.271-17~bpo10+1_all.deb
wget http://ftp.ru.debian.org/debian/pool/non-free/b/broadcom-sta/broadcom-sta-dkms_6.30.223.271-17~bpo10+1_all.deb
wget http://ftp.ru.debian.org/debian/pool/non-free/b/broadcom-sta/broadcom-sta-source_6.30.223.271-17~bpo10+1_all.deb
</code></pre></div><ol start=3>
<li>使用以下命令安装驱动程序：</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo dpkg -i broadcom-sta-common_6.30.223.271-15~bpo10+1_all.deb
sudo dpkg -i broadcom-sta-dkms_6.30.223.271-15~bpo10+1_all.deb
sudo dpkg -i broadcom-sta-source_6.30.223.271-15~bpo10+1_all.deb
</code></pre></div></li>
<li>终端颜色重新配置</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 代码注释配色反人类，可以用如下方法解决：</span>
/usr/share/terminalwidget5/color-schemes/*.colorschme
54: 24, 24, <span style=color:#ae81ff>178</span> --&gt; 46, 100, 166。

<span style=color:#75715e># 安装terminator/tmux</span>
sudo apt install terminator tmux

<span style=color:#75715e># 测试256色</span>
curl -s https://gist.githubusercontent.com/HaleTom/89ffe32783f89f403bba96bd7bcd1263/raw/ | bash

<span style=color:#75715e>## 如果不支持，开启</span>
<span style=color:#75715e>#vim ~/.bashrc</span>
<span style=color:#75715e>#增加命令&#34;export TERM=xterm-256color&#34;.</span>

<span style=color:#75715e># 安装插件</span>
</code></pre></div><ol start=7>
<li>fcitx 配置</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo vim /usr/share/fcitx/configdesc/config.desc

<span style=color:#f92672>[</span>output<span style=color:#f92672>]</span>
<span style=color:#ae81ff>9</span>
</code></pre></div><ol start=8>
<li>安装 krusader/terminator</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget -c https://releases.pagure.org/virt-viewer/virt-viewer-9.0.tar.gz
extract virt-viewer-9.0.tar.gz
cd virt-viewer-9.0
./configure --prefix<span style=color:#f92672>=</span>/usr
</code></pre></div><h2 id=docker>docker<a hidden class=anchor aria-hidden=true href=#docker>#</a></h2>
<h3 id=安装-dockerdocker-compose>安装 docker/docker-compose<a hidden class=anchor aria-hidden=true href=#安装-dockerdocker-compose>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun

<span style=color:#75715e># 安装 docker-compose</span>
<span style=color:#75715e># debian/centos</span>
sudo curl -L <span style=color:#e6db74>&#34;https://get.daocloud.io/docker/compose/releases/download/1.29.1/docker-compose-</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>-</span><span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

<span style=color:#75715e># Raspberry</span>
sudo apt update -y <span style=color:#f92672>&amp;&amp;</span> sudo apt install libffi-dev libssl-dev python3 python3-pip -y
sudo pip install docker-compose
</code></pre></div><h3 id=修改dockerhub源>修改dockerhub源<a hidden class=anchor aria-hidden=true href=#修改dockerhub源>#</a></h3>
<ol>
<li>参考 <a href=https://strikefreedom.top/migrate-docker-installation-directory>Strike Freedom</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker info | grep <span style=color:#e6db74>&#34;Docker Root Dir&#34;</span>

sudo mkdir -p /home/dockerlib
<span style=color:#e6db74>&#34;data-root&#34;</span>: <span style=color:#e6db74>&#34;/home/dockerlib/&#34;</span>,
<span style=color:#e6db74>&#34;data-root&#34;</span>: <span style=color:#e6db74>&#34;/home/share/bkp/lxc_dockers/docker/&#34;</span>,

<span style=color:#75715e># &gt;=17.5</span>
sudo tee /etc/docker/daemon.json <span style=color:#e6db74>&lt;&lt;-&#39;EOF&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;registry-mirrors&#34;: [&#34;https://xxx.mirror.aliyuncs.com&#34;],
</span><span style=color:#e6db74>  &#34;data-root&#34;: &#34;/home/dockerlib/&#34;,
</span><span style=color:#e6db74>  &#34;log-driver&#34;:&#34;json-file&#34;,
</span><span style=color:#e6db74>  &#34;log-opts&#34;:{
</span><span style=color:#e6db74>      &#34;max-size&#34; :&#34;5m&#34;,
</span><span style=color:#e6db74>      &#34;max-file&#34;:&#34;1&#34;
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>EOF</span>
sudo systemctl daemon-reload <span style=color:#f92672>&amp;&amp;</span> sudo systemctl restart docker
</code></pre></div><h3 id=添加用户组>添加用户组<a hidden class=anchor aria-hidden=true href=#添加用户组>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo cat /etc/group | grep docker
<span style=color:#75715e># 最后的冒号后面没有用户</span>

sudo gpasswd -a <span style=color:#e6db74>${</span>USER<span style=color:#e6db74>}</span> docker

sudo systemctl restart docker
</code></pre></div><h3 id=问题排查>问题排查<a hidden class=anchor aria-hidden=true href=#问题排查>#</a></h3>
<ol>
<li>socket权限不足</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo chmod a+rw /var/run/docker.sock

sudo systemctl restart docker
</code></pre></div><h3 id=卸载>卸载<a hidden class=anchor aria-hidden=true href=#卸载>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker stop <span style=color:#66d9ef>$(</span>docker ps -aq<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> docker system prune -a

rm /usr/local/bin/docker-compose

dpkg -l | grep -i docker

apt-get purge -y docker-engine docker docker.io docker-ce docker-ce-cli docker-ce-rootless-extras docker-scan-plugin <span style=color:#f92672>&amp;&amp;</span> apt-get autoremove -y --purge docker-engine docker docker.io docker-ce docker-ce-cli docker-ce-rootless-extras docker-scan-plugin
apt autoremove <span style=color:#f92672>&amp;&amp;</span> apt autoclean

rm -rf /var/lib/docker /etc/docker /etc/apparmor.d/docker /var/run/docker.sock <span style=color:#f92672>&amp;&amp;</span> groupdel docker
</code></pre></div><h2 id=虚拟机>虚拟机<a hidden class=anchor aria-hidden=true href=#虚拟机>#</a></h2>
<ol>
<li>虚拟机安装</li>
<li>openwrt, 参照[最佳实践-树莓派]</li>
</ol>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://suai.tk/tags/%E9%85%8D%E7%BD%AE/>配置</a></li>
<li><a href=https://suai.tk/tags/linux/>linux</a></li>
<li><a href=https://suai.tk/tags/%E8%BD%AF%E4%BB%B6/>软件</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://suai.tk/posts/best_git/>
<span class=title>« Prev</span>
<br>
<span>Git学习</span>
</a>
<a class=next href=https://suai.tk/posts/building_localhost/>
<span class=title>Next »</span>
<br>
<span>局域网建设</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share 最佳实践-Linux环境配置 on twitter" href="https://twitter.com/intent/tweet/?text=%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-Linux%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae&url=https%3a%2f%2fsuai.tk%2fposts%2fbest_config_linux%2f&hashtags=%e9%85%8d%e7%bd%ae%2clinux%2c%e8%bd%af%e4%bb%b6"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 最佳实践-Linux环境配置 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fsuai.tk%2fposts%2fbest_config_linux%2f&title=%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-Linux%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae&summary=%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-Linux%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae&source=https%3a%2f%2fsuai.tk%2fposts%2fbest_config_linux%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 最佳实践-Linux环境配置 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsuai.tk%2fposts%2fbest_config_linux%2f&title=%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-Linux%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 最佳实践-Linux环境配置 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsuai.tk%2fposts%2fbest_config_linux%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 最佳实践-Linux环境配置 on whatsapp" href="https://api.whatsapp.com/send?text=%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-Linux%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae%20-%20https%3a%2f%2fsuai.tk%2fposts%2fbest_config_linux%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 最佳实践-Linux环境配置 on telegram" href="https://telegram.me/share/url?text=%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-Linux%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae&url=https%3a%2f%2fsuai.tk%2fposts%2fbest_config_linux%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://suai.tk/>DataLearning</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>